CREATE OR REPLACE VIEW AP21.SIAP_CAY3
    (Y3COCODE,Y3HBRCODE,Y3IMCODE,Y3HLOTSIZE,Y3TANI,Y3SPFRT,Y3KSEQNO,Y3KOTEICD,
    Y3NGKBN,Y3RMSGCODE,Y3GBUMONCD,Y3KAKOSYUCD,Y3SETUCD,Y3RMWKNAME,Y3RMSAJIKAN1,
    Y3RMSEISAN,Y3RMTANK,Y3RECIPEID,Y3RECIPECD,Y3RECIPEVER,Y3RESOUCEGROUPCD,
    Y3OPERATIONGROUPCD,Y3RESOUCECD,Y3RECIPEPRIORITY,Y3JTSTDATE,Y3PSEDDATE,
    Y3SENDDIVISION)
AS
SELECT '001' AS Y3COCODE -- 会社コード(自社マスタ攝津製油固定)
	  ,'001' AS Y3HBRCODE -- 本支店コード(暫定！攝津製油固定)
	  ,RCPS.ITEM_CD AS Y3IMCODE -- 品目コード
	  ,RCPS.ITEM_STD_QTY AS Y3HLOTSIZE -- 標準ロットサイズ
	  ,NULL AS Y3TANI -- 単位
	  ,0 AS Y3SPFRT -- 不良率
	  ,DECODE(RCPS.RECIPE_USE, 3, 10, 4, 30) AS Y3KSEQNO -- 工程順序
	  ,DECODE(RCPS.RECIPE_USE, 3, '10', 4, '30') AS Y3KOTEICD -- 工程コード
	  ,0 AS Y3NGKBN -- 内外区分(0..社内加工)
	  ,0 AS Y3RMSGCODE -- 作業区分(未使用 0)
	  ,RCPS.ACCOUNT_CD AS Y3GBUMONCD -- 原価部門コード
	  ,NULL AS Y3KAKOSYUCD -- 加工種コード(省略)
	  ,substrb(RCPA.RESOUCE_CD, 1, 10) AS Y3SETUCD -- 設備コード
	  ,DECODE(RCPS.RECIPE_USE, 3, '調合', 4, '充填') AS Y3RMWKNAME -- 作業名称
	   --    ,ROUND(DECODE(RCPS.ITEM_STD_QTY, 0, 0, (RCPA.WORK1 * 1 + RCPA.WORK2) / RCPS.ITEM_STD_QTY), 4) AS Y3RMSAJIKAN1 -- 予定作業時間(標準生産量）
	  ,ROUND(DECODE(RCPS.ITEM_STD_QTY
				   ,0
				   ,0
				   ,(RCPA.WORK1 * 1 + RCPA.WORK2) / RCPS.ITEM_STD_QTY /
					DECODE(NVL(ITEM.KG_OF_FRACTION_MANAGEMENT, 0)
						  ,0
						  ,1
						  ,NVL(ITEM.KG_OF_FRACTION_MANAGEMENT, 1)))
			,4) AS Y3RMSAJIKAN1 -- 予定作業時間(標準生産量）
	  ,1 AS Y3RMSEISAN -- 製造予定数
	  ,0 AS Y3RMTANK -- 仕入単価(未使用 0)
	  ,RCPS.RECIPE_ID -- レシピインデックス
	  ,RCPS.RECIPE_CD -- レシピコード
	  ,RCPS.RECIPE_VERSION Y3RECIPEVER -- 処方バージョン
	  ,RCPA.RESOUCE_GROUP_CD -- 設備グループコード
	  ,RCPA.OPERATION_GROUP_CD -- 工程グループコード
	  ,RCPA.RESOUCE_CD -- 設備コード
	  ,RCPS.RECIPE_PRIORITY -- 処方優先度
	  ,TO_NUMBER(TO_CHAR(RCPS.START_DATE, 'YYYYMMDD')) AS Y3JTSTDATE -- 有効日(YYYYMMDD）
	  ,TO_NUMBER(TO_CHAR(RCPS.END_DATE, 'YYYYMMDD')) AS Y3PSEDDATE -- 失効日(YYYYMMDD)
	   -- 2011/06/17 ADD START
	  ,ITEM.COST_DIVISION -- マスタ送信区分
FROM   SIAP_RECIPE_STD RCPS -- 標準処方
	  ,ITEM ITEM
	  ,(SELECT RECIPE_ID
			   --              ,NVL(PROCESS_WORK_TIME1, 0) AS WORK1
			   --              ,NVL(PROCESS_WORK_TIME2, 0) AS WORK2
			  ,NVL(MAN_WORK_TIME1, 0) AS WORK1
			  ,NVL(MAN_WORK_TIME2, 0) AS WORK2
			  ,RESOUCE_CD
			  ,RESOUCE_GROUP_CD
			  ,OPERATION_GROUP_CD
			  ,RECIPE_PRIORITY
		FROM   (SELECT RECIPE_ID
					   --                      ,PROCESS_WORK_TIME1
					   --                      ,PROCESS_WORK_TIME2
					  ,MAN_WORK_TIME1
					  ,MAN_WORK_TIME2
					  ,RESOUCE_CD
					  ,RESOUCE_GROUP_CD
					  ,OPERATION_GROUP_CD
					  ,RECIPE_PRIORITY
					   --                      ,First_Value(RECIPE_PRIORITY) -- 優先度が最大のものを品目ごとの標準処方とする。
					   --                       OVER(PARTITION BY RECIPE_ID, RESOUCE_GROUP_CD, OPERATION_GROUP_CD ORDER BY RECIPE_PRIORITY DESC, RESOUCE_CD ASC) AS ITEM_RECIPE
					  ,First_Value(RESOUCE_CD) -- 優先度が同じものが複数ある場合は、設備コード若いもの。
					   OVER(PARTITION BY RECIPE_ID, RESOUCE_GROUP_CD, OPERATION_GROUP_CD ORDER BY RECIPE_PRIORITY DESC, RESOUCE_CD ASC) AS ITEM_RESOUCE_CD
				FROM   AP21.RECIPE_ASPROVA -- 基本処方（ASPROVA）
				)
		--        WHERE  RECIPE_PRIORITY = ITEM_RECIPE
		WHERE  RESOUCE_CD = ITEM_RESOUCE_CD) RCPA
WHERE  RCPS.RECIPE_ID = RCPA.RECIPE_ID
AND    RCPS.ITEM_CD = ITEM.ITEM_CD(+)
/
COMMENT ON TABLE AP21.SIAP_CAY3 IS 'ＣＡ作業手順マスタ'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3COCODE IS '会社コード(自社マスタ攝津製油固定)'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3HBRCODE IS '本支店コード(暫定！攝津製油固定)'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3IMCODE IS '品目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3HLOTSIZE IS '標準ロットサイズ'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3TANI IS '単位'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3SPFRT IS '不良率'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3KSEQNO IS '工程順序'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3KOTEICD IS '工程コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3NGKBN IS '内外区分(0..社内加工)'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RMSGCODE IS '作業区分(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3GBUMONCD IS '原価部門コード(テーブル未設定のため追加必要)'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3KAKOSYUCD IS '加工種コード(省略)'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3SETUCD IS '設備コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RMWKNAME IS '作業名称'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RMSAJIKAN1 IS '予定作業時間(標準生産量）'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RMSEISAN IS '製造予定数'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RMTANK IS '仕入単価'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RECIPEID IS 'レシピインデックス'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RECIPECD IS '処方コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RECIPEVER IS '処方バージョン'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RESOUCEGROUPCD IS '設備グループコード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3OPERATIONGROUPCD IS '工程グループコード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RESOUCECD IS '設備コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3RECIPEPRIORITY IS '処方優先度'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3JTSTDATE IS '有効開始日'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3PSEDDATE IS '有効終了日'
/
COMMENT ON COLUMN AP21.SIAP_CAY3.Y3SENDDIVISION IS '送信区分|0:未送信 1:送信済'
/
