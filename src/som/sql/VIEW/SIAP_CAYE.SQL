CREATE OR REPLACE VIEW AP21.SIAP_CAYE
    (YECOCODE,YEHBRCODE,YEURKUBUN,YEURSIDT,YEURIDNO,YEGYOBAN,YEIMCODE,YEHINNM,
    YESERIESCD,YEGBUMONCD,YETACODE,YEPLTSCODE,YETSNAME011,YETSNAME021,YEJUODRNO,
    YEJUGYOBAN,YESTRINQTY,YESTRINTANK,YESTRKIN,YESYHKBN,YETRSYHKIN,YEACNO,
    YEACHOJO,YESPHCMT,YETRKANNOU,YEATACNO,YEATACHOJO,YELOTNO,YESGMNTCD,
    YESGMNTCDA,YESGMNTCDB,YESGMNTCDC,YESGMNTCD2,YEPROJECTCD,YEHSMTDNO,YEHSMTGNO,
    YESDENCRDT)
AS
SELECT '001' AS YECOCODE -- 会社コード(※共通仕様参照。)
	  ,'001' AS YEHBRCODE -- 本支店コード(※共通仕様参照。)
	  ,CASE --  1:売上 2:返品 3:値引 4:運賃 11:売上 12:返品 13:値引 14:運賃
		   WHEN CATEGORY_DIVISION = -1 THEN
			2 -- -1:売上取消      → 0..売上取消
		   WHEN CATEGORY_DIVISION = -2 THEN
			0 -- -2:返品取消      → 2..返品取消
		   WHEN CATEGORY_DIVISION = -3 THEN
			0 -- -3:値引取消      → 6..値引取消
		   WHEN CATEGORY_DIVISION = -4 THEN
			2 -- -4:運賃取消      → 7..現金売上取消
		   WHEN CATEGORY_DIVISION = 1 THEN
			0 -- 1:売上           → 0..売上
		   WHEN CATEGORY_DIVISION = 2 THEN
			2 -- 2:返品           → 2..返品
		   WHEN CATEGORY_DIVISION = 3 THEN
			6 -- 3:値引           → 6..値引
		   WHEN CATEGORY_DIVISION = 4 THEN
			0 -- 4:運賃           → 7..現金売上
	   
	   -- 2011.7.27 ADD 前受金対応
		   WHEN CATEGORY_DIVISION = -11 THEN
			2 -- -11:売上取消      → 0..売上取消
		   WHEN CATEGORY_DIVISION = -12 THEN
			0 -- -12:返品取消      → 2..返品取消
		   WHEN CATEGORY_DIVISION = -13 THEN
			0 -- -13:値引取消      → 6..値引取消
		   WHEN CATEGORY_DIVISION = -14 THEN
			2 -- -14:運賃取消      → 7..現金売上取消
		   WHEN CATEGORY_DIVISION = 11 THEN
			0 -- 11:売上           → 0..売上
		   WHEN CATEGORY_DIVISION = 12 THEN
			2 -- 12:返品           → 2..返品
		   WHEN CATEGORY_DIVISION = 13 THEN
			6 -- 13:値引           → 6..値引
		   WHEN CATEGORY_DIVISION = 14 THEN
			0 -- 14:運賃           → 7..現金売上
	   
		   ELSE
			0
	   END AS YEURKUBUN -- 売上区分(0..売上 2..返品 6..値引 7..現金売上 8..現金返品)
	  ,TO_NUMBER(TO_CHAR(SALES_DATE, 'YYYYMMDD')) AS YEURSIDT -- 売上日付(YYYYMMDD)
	  ,SALES_NO AS YEURIDNO -- 売上伝票番号
	  ,1 AS YEGYOBAN -- 行番号
	  ,SALES.ITEM_CD AS YEIMCODE -- 品目コード(20桁以内)
	  ,NULL AS YEHINNM -- 品目名称(未使用 NULL)
	  ,NULL AS YESERIESCD -- 製品シリーズコード(未使用 NULL)
	  ,ACCOUNT_DEBIT_SECTION_CD AS YEGBUMONCD -- 原価部門コード(未使用 NULL)
	  ,SUBSTR(SALES.INPUTOR_CD, 2, 6) AS YETACODE -- 担当者コード(未使用 NULL)
	  ,NULL AS YEPLTSCODE -- 得意先コード(未使用 NULL)
	  ,NULL AS YETSNAME011 -- 得意先名称１(未使用 NULL)
	  ,NULL AS YETSNAME021 -- 得意先名称２(未使用 NULL)
	  ,NULL AS YEJUODRNO -- 受注番号(未使用 NULL)
	  ,0 AS YEJUGYOBAN -- 受注行番号(未使用 0)
	   --      ,SALES_QUANTITY * NVL(ITEM_QUEUE.KG_OF_FRACTION_MANAGEMENT, 0) AS YESTRINQTY -- 実際売上数量
	  ,DECODE(SHIPPING.SHIPPING_RESULT_QUANTITY
			 ,NULL
			 ,SALES_QUANTITY
			 ,SHIPPING.SHIPPING_RESULT_QUANTITY) *
	   NVL(ITEM_QUEUE.KG_OF_FRACTION_MANAGEMENT, 0) AS YESTRINQTY -- 実際売上数量
	  ,ROUND(SALES_AMOUNT /
			 DECODE(SALES_QUANTITY *
					NVL(ITEM_QUEUE.KG_OF_FRACTION_MANAGEMENT, 0)
				   ,0
				   ,1
				   ,SALES_QUANTITY *
					NVL(ITEM_QUEUE.KG_OF_FRACTION_MANAGEMENT, 0))
			,3) AS YESTRINTANK -- 実際売上単価
	  ,SALES_AMOUNT AS YESTRKIN -- 実際売上金額
	  ,0 AS YESYHKBN -- 消費税区分(未使用 0)
	  ,0 AS YETRSYHKIN -- 消費税額(未使用 0)
	  ,CREDIT_TITLE_CD AS YEACNO -- 勘定科目コード
	  ,'0000000000' AS YEACHOJO -- 補助科目コード
	  ,NULL AS YESPHCMT -- 摘要(未使用 NULL)
	  ,0 AS YETRKANNOU -- 完納区分(未使用 0)
	  ,NULL AS YEATACNO -- 相手勘定科目コード(未使用 NULL)
	  ,NULL AS YEATACHOJO -- 相手補助科目コード(未使用 NULL)
	  ,NULL AS YELOTNO -- ロット番号(未使用 NULL)
	   -- 2011/06/09 品目分類CD追加 ------------------------------>
	   --    ,NULL AS YESGMNTCD -- セグメントコード(未使用 NULL)
	  ,ITEM_QUEUE.ITEM_CATEGORY AS YESGMNTCD -- セグメントコード(未使用 NULL)
	   --<----------------------------------------------------------
	  ,NULL AS YESGMNTCDA -- セグメントコード（大分類）(未使用 NULL)
	  ,NULL AS YESGMNTCDB -- セグメントコード（中分類）(未使用 NULL)
	  ,NULL AS YESGMNTCDC -- セグメントコード（小分類）(未使用 NULL)
	  ,NULL AS YESGMNTCD2 -- セグメントコード２(未使用 NULL)
	  ,NULL AS YEPROJECTCD -- プロジェクトコード(未使用 NULL)
	  ,NULL AS YEHSMTDNO -- 発生元伝票番号(未使用 NULL)
	  ,0    AS YEHSMTGNO -- 発生元伝票番号行番号(未使用 0)
	  ,0    AS YESDENCRDT -- 仕訳伝票作成日(未使用 0)
FROM   AP21.SALES
	   
	  ,(SELECT SHIPPING.SHIPPING_NO
			  ,SUM(DETAIL.SHIPPING_RESULT_QUANTITY) SHIPPING_RESULT_QUANTITY
		FROM   AP21.SHIPPING, AP21.SHIPPING_DETAIL DETAIL
		WHERE  SHIPPING.SHIPPING_NO = DETAIL.SHIPPING_NO(+)
		GROUP  BY SHIPPING.SHIPPING_NO) SHIPPING
	   
	  ,AP21.ITEM_QUEUE
	  ,(SELECT ITEM_CD, MAX(VERSION) VERSION
		FROM   AP21.ITEM_QUEUE
		GROUP  BY ITEM_CD) MAX_ITEM_QUEUE
WHERE  DATA_TYPE = 1 -- 1:売上
AND    TO_CHAR(SALES_DATE, 'YYYYMMDD') > '20091000'
AND    ITEM_QUEUE.TYPE_DIVISION <> 9 -- その他以外
AND    ITEM_QUEUE.SHIPPER_DIVISION <> 3 -- 油脂以外
AND    SALES.ITEM_CD = ITEM_QUEUE.ITEM_CD
AND    ITEM_QUEUE.ITEM_CD = MAX_ITEM_QUEUE.ITEM_CD
AND    ITEM_QUEUE.VERSION = MAX_ITEM_QUEUE.VERSION
AND    SALES.SHIPPING_NO = SHIPPING.SHIPPING_NO(+)
/
COMMENT ON TABLE AP21.SIAP_CAYE IS 'ＣＡ売上ファイル'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YECOCODE IS '会社コード(※共通仕様参照。)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEHBRCODE IS '本支店コード(※共通仕様参照。)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEURKUBUN IS '売上区分(0..売上 2..返品 6..値引 7..現金売上 8..現金返品)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEURSIDT IS '売上日付(YYYYMMDD)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEURIDNO IS '売上伝票番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEGYOBAN IS '行番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEIMCODE IS '品目コード(20桁以内)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEHINNM IS '品目名称(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESERIESCD IS '製品シリーズコード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEGBUMONCD IS '原価部門コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YETACODE IS '担当者コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEPLTSCODE IS '得意先コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YETSNAME011 IS '得意先名称１(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YETSNAME021 IS '得意先名称２(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEJUODRNO IS '受注番号(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEJUGYOBAN IS '受注行番号(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESTRINQTY IS '実際売上数量'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESTRINTANK IS '実際売上単価'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESTRKIN IS '実際売上金額'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESYHKBN IS '消費税区分(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YETRSYHKIN IS '消費税額(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEACNO IS '勘定科目コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEACHOJO IS '補助科目コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESPHCMT IS '摘要(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YETRKANNOU IS '完納区分(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEATACNO IS '相手勘定科目コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEATACHOJO IS '相手補助科目コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YELOTNO IS 'ロット番号(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESGMNTCD IS 'セグメントコード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESGMNTCDA IS 'セグメントコード（大分類）(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESGMNTCDB IS 'セグメントコード（中分類）(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESGMNTCDC IS 'セグメントコード（小分類）(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESGMNTCD2 IS 'セグメントコード２(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEPROJECTCD IS 'プロジェクトコード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEHSMTDNO IS '発生元伝票番号(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YEHSMTGNO IS '発生元伝票番号行番号(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYE.YESDENCRDT IS '仕訳伝票作成日(未使用 0)'
/
