CREATE OR REPLACE VIEW AP21.SIAP_CAY4
    (Y4COCODE,Y4HBRCODE,Y4IMCODE,Y4KSEQNO,Y4HINSEQNO,Y4KOIMCODE,Y4SPKUBUN,
    Y4SPQUTY,Y4STANI,Y4JTSTDATE,Y4PSEDDATE,Y4RECIPEID,Y4RECIPECD,Y4RECIPEVER,
    Y4RECIPEPRIORITY,Y4SIKYU,Y4SPSCRP,Y4SENDDIVISION,Y4KOSENDDIVISION)
AS
SELECT '001' AS Y4COCODE -- 会社コード(自社マスタ攝津製油固定)
	  ,'001' AS Y4HBRCODE -- 本支店コード(暫定！攝津製油固定)
	  ,RCPM.P_ITEM_CD AS Y4IMCODE -- 品目コード
	  ,DECODE(RCPH.RECIPE_USE, 3, 10, 4, 30) AS Y4KSEQNO -- 工程順序(0固定)
	  ,RCPM.C_ITEM_SEQ AS Y4HINSEQNO -- 品目順序(投入順序)
	  ,RCPM.C_ITEM_CD AS Y4KOIMCODE -- 子品目コード(20桁以内)
	  ,0 AS Y4SPKUBUN -- 使用数区分(固定 0)
	  ,ROUND(RCPM.QTY /
			 DECODE(NVL(PARENT_ITEM.KG_OF_FRACTION_MANAGEMENT, 0)
				   ,0
				   ,1
				   ,NVL(PARENT_ITEM.KG_OF_FRACTION_MANAGEMENT, 1))
			,5) Y4SPQUTY -- 使用数
	  ,SUBSTRB(DECODE(RCPM.RECIPE_USE
					 ,3
					 ,'kg'
					 ,4
					 ,NVL(NAME.NAME01, 'kg')
					 ,'個')
			  ,1
			  ,6) AS Y4STANI -- 使用単位
	  ,TO_NUMBER(TO_CHAR(RCPH.START_DATE, 'YYYYMMDD')) AS Y4JTSTDATE -- 有効日(YYYYMMDD）
	  ,TO_NUMBER(TO_CHAR(RCPH.END_DATE, 'YYYYMMDD')) AS Y4PSEDDATE -- 失効日(YYYYMMDD)
	  ,RCPM.RECIPE_ID -- レシピインデックス
	  ,RCPM.RECIPE_CD -- 処方コード
	  ,RCPM.RECIPE_VERSION Y4RECIPEVER -- 処方バージョン
	  ,RCPM.RECIPE_PRIORITY -- 処方優先度
	   --      ,DECODE(PAQ.SUPPLIED_GOODS_DIVISION, '3', 1, 0) AS Y4SIKYU -- 支給区分(0..無償支給 1..有償支給)
	  ,0 -- 支給区分(無償支給)
	  ,0 AS Y4SPSCRP -- 歩留率(未使用 0)
	   -- 2011/06/17 ADD START
	  ,PARENT_ITEM.COST_DIVISION PARENT_COST_DIVISION
	  ,ITEM.COST_DIVISION
FROM   (SELECT RCPS.RECIPE_USE AS RECIPE_USE
			  ,RCPS.ITEM_CD AS P_ITEM_CD -- 親品目コード
			  ,RCPS.RECIPE_ID AS RECIPE_ID
			  ,RCPF.ITEM_CD AS C_ITEM_CD -- 子品目コード
			  ,RCPF.ITEM_SEQ AS C_ITEM_SEQ -- 子品目順番
			  ,DECODE(RCPS.ITEM_STD_QTY, 0, 0, RCPF.QTY / RCPS.ITEM_STD_QTY) AS QTY
			  ,RCPS.RECIPE_CD
			  ,RCPS.RECIPE_VERSION
			  ,RCPS.RECIPE_PRIORITY
		FROM   (SELECT RECIPE_ID
					  ,ITEM_CD
					  ,SUM(QTY) AS QTY
					  ,MIN(SEQ)
					  ,ROW_NUMBER() OVER(PARTITION BY RECIPE_ID ORDER BY MIN(STEP_NO), MIN(SEQ)) AS ITEM_SEQ
				FROM   AP21.RECIPE_FORMULA
				WHERE  LINE_TYPE < 0 -- 原材料（配合タブ）
				GROUP  BY RECIPE_ID, ITEM_CD
				ORDER  BY RECIPE_ID, MIN(STEP_NO), MIN(SEQ)) RCPF -- 基本処方（配合）
			  ,SIAP_RECIPE_STD RCPS -- 標準処方
		WHERE  RCPF.RECIPE_ID = RCPS.RECIPE_ID) RCPM
	  ,AP21.RECIPE_HEADER RCPH
	  ,AP21.ITEM ITEM -- 品目マスタ
	  ,AP21.ITEM PARENT_ITEM -- 親品目マスタ
	  ,AP21.PURCHASE_ATTRIBUTE_QUEUE PAQ -- 購入品扱い属性
	  ,AP21.NAMES NAME -- 単位名称
WHERE  RCPH.RECIPE_ID = RCPM.RECIPE_ID
AND    RCPM.C_ITEM_CD = ITEM.ITEM_CD
AND    ITEM.ITEM_CD = PAQ.ITEM_CD(+)
AND    ITEM.VERSION = PAQ.VERSION(+)
AND    RCPM.P_ITEM_CD = PARENT_ITEM.ITEM_CD(+)
AND    ITEM.UNIT_OF_OPERATION_MANAGEMENT = NAME.NAME_CD(+)
AND    NAME.NAME_DIVISION(+) = 'UNIT'
/
COMMENT ON TABLE AP21.SIAP_CAY4 IS 'ＣＡ部品構成マスタ'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4COCODE IS '会社コード(自社マスタ攝津製油固定)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4HBRCODE IS '本支店コード(暫定！攝津製油固定)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4IMCODE IS '品目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4KSEQNO IS '工程順序(0固定)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4HINSEQNO IS '品目順序(投入順序)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4KOIMCODE IS '子品目コード(20桁以内)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4SPKUBUN IS '使用数区分(固定 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4SPQUTY IS '使用数'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4STANI IS '使用単位'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4JTSTDATE IS '有効日(YYYYMMDD）'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4PSEDDATE IS '失効日(YYYYMMDD)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4RECIPEID IS 'レシピインデックス'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4RECIPECD IS '処方コード'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4RECIPEVER IS '処方バージョン'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4RECIPEPRIORITY IS '処方優先度'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4SIKYU IS '支給区分(0..無償支給 1..有償支給)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4SPSCRP IS '歩留率(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4SENDDIVISION IS '送信区分(親品目)|0:未送信 1:送信済'
/
COMMENT ON COLUMN AP21.SIAP_CAY4.Y4KOSENDDIVISION IS '送信区分(子品目)|0:未送信 1:送信済'
/
