CREATE OR REPLACE VIEW AP21.SIAP_CAYC
    (YCCOCODE,YCHBRCODE,YCKESANKI,YCODODRNO1,YCHKDATE,YCIMCODE,YCHINNM,
    YCGBUMONCD,YCTACODE,YCKSSICODE,YCSINAME011,YCSINAME021,YCODDUEDT,YCSTRINQTY,
    YCSTRINTANK,YCSTRKIN,YCACNO,YCACHOJO,YCLOTNO,YCODRKQTY,YCSSHRQTY,YCODUKEBI,
    YCODSTATUS,YCSPHCMT,YCPROJECTCD,YCSSODRNO,YCKOUTEICD)
AS
SELECT '001' AS YCCOCODE -- 会社コード( ◎ ※共通仕様参照。)
	  ,'001' AS YCHBRCODE -- 本支店コード(※共通仕様参照。)
	  ,'000' AS YCKESANKI -- 決算期(※共通仕様参照。)
	  ,PURC.BUY_SUBCONTRACT_ORDER_NO AS YCODODRNO1 -- 注文番号
	  ,TO_NUMBER(TO_CHAR(PURC.ORDER_DATE, 'YYYYMMDD')) AS YCHKDATE -- 発注日(YYYYMMDD)
	  ,PURC.ITEM_CD AS YCIMCODE -- 品目コード(20桁以内)
	  ,PURC.ITEM_NAME AS YCHINNM -- 品目名称(未使用 NULL)
	  ,NVL(PURC.ACCOUNT_DEBIT_SECTION_CD
		  ,NVL((SELECT SECTION_CD
			   FROM   AP21.PURCHASE_ATTRIBUTE_QUEUE Q, AP21.ITEM I
			   WHERE  I.ITEM_CD = PURC.ITEM_CD
			   AND    I.ITEM_CD = Q.ITEM_CD
			   AND    I.VERSION = Q.VERSION)
			  ,'0101')) AS YCGBUMONCD -- 原価部門コード
	  ,NULL AS YCTACODE -- 担当者コード(未使用 NULL)
	  ,NULL AS YCKSSICODE -- 仕入先コード(未使用 NULL)
	  ,NULL AS YCSINAME011 -- 仕入先名称１(未使用 NULL)
	  ,NULL AS YCSINAME021 -- 仕入先名称２(未使用 NULL)
	  ,0 AS YCODDUEDT -- 希望納期(未使用 0)
	  ,PURC.ORDER_CONVERT_QUANTITY AS YCSTRINQTY -- 数量
	   --      ,PURC.ORDER_UNITPRICE AS YCSTRINTANK -- 単価
	  ,ROUND(DECODE(PURC.ORDER_CONVERT_QUANTITY
				   ,0
				   ,0
				   ,PURC.SUPPLIER_ORD_AMOUNT / PURC.ORDER_CONVERT_QUANTITY)
			,4) AS YCSTRINTANK -- 単価
	  ,PURC.SUPPLIER_ORD_AMOUNT AS YCSTRKIN -- 金額
	  ,NULL AS YCACNO -- 勘定科目コード(未使用 NULL)
	  ,NULL AS YCACHOJO -- 補助科目コード(未使用 NULL)
	  ,NULL AS YCLOTNO -- ロット番号(未使用 NULL)
	  ,0 AS YCODRKQTY -- 累計受入数(未使用 0)
	  ,0 AS YCSSHRQTY -- 不良数(未使用 0)
	   --    受入完了日(発注ステータスが2:完納の場合、受入完了日(YYYYMMDD)その他のとき、0)
	   --    ,DECODE(PURC.DELIVERY_COMP
	   --           ,1
	   --           ,TO_NUMBER(TO_CHAR(PURC.ACCEPT_DATE, 'YYYYMMDD'))
	   --           ,0) AS YCODUKEBI
	  ,DECODE(PURC.ACCEPT_DATE
			 ,NULL
			 ,0
			 ,TO_NUMBER(TO_CHAR(PURC.ACCEPT_DATE, 'YYYYMMDD')))
	  ,CASE -- 購買ステータス|1:展開済 2:発注書発行済 3:納期調整中 4:納期確定 5:入荷登録済 6:受入登録済 7:発注書未発行
		   WHEN PURC.STATUS < 6 THEN
			0 -- 1:登録済 2:発注書発行済 3:納期調整中 4:納期確定 5:入荷登録済 → 0:注文書発行
		   ELSE
		   --          CASE PURC.DELIVERY_COMP
		   --              WHEN 0 THEN
		   --               1
		   --              ELSE
		   --               2
		   --          END -- 完納区分 0:未完納 |1:完納
			2
	   END AS YCODSTATUS -- 発注ステータス(0:注文書発行 1:分納 2:完納)
	  ,NULL AS YCSPHCMT -- 摘要(未使用 NULL)
	  ,NULL AS YCPROJECTCD -- プロジェクトコード(未使用 NULL)
	  ,NULL AS YCSSODRNO -- 製造オーダー番号(工程内外注用　未使用 NULL)
	  ,NULL AS YCKOUTEICD -- 工程コード(工程内外注用　未使用 NULL)
FROM   AP21.PURCHASE_SUBCONTRACT PURC
	  ,(SELECT BUY_SUBCONTRACT_ORDER_NO
			  ,NVL(ORDER_DIVIDE_NO, '000') ORDER_DIVIDE_NO
			  ,MAX(ROW_NO) ROW_NO
			  ,SLIP_NO
		FROM   AP21.PURCHASE_SUBCONTRACT
		GROUP  BY BUY_SUBCONTRACT_ORDER_NO
				 ,NVL(ORDER_DIVIDE_NO, '000')
				 ,SLIP_NO) MAX_PURC
	  ,ITEM
WHERE  PURC.CATEGORY_DIVISION = 1
	  --     オーダー区分|1:原材料 2:外注製品（直送） 3:外注製品（非直送） 4:スポット品 5:仕入直送品 6:仕入在庫品
	  --  AND PURC.ORDER_DIVISION in (1,4,6)
	  -- 外注製品を対象にする
AND    PURC.ORDER_DIVISION IN (1, 2, 3, 4, 6)
AND    PURC.STATUS IN (2, 3, 4, 5, 6) -- 注文書発行済み以上対象
AND    PURC.BUY_SUBCONTRACT_ORDER_NO = MAX_PURC.BUY_SUBCONTRACT_ORDER_NO
AND    NVL(PURC.ORDER_DIVIDE_NO, '000') =
	   NVL(MAX_PURC.ORDER_DIVIDE_NO, '000')
AND    PURC.ROW_NO = MAX_PURC.ROW_NO
AND    PURC.SLIP_NO = MAX_PURC.SLIP_NO
AND    ITEM.TYPE_DIVISION <> 4 -- 仕入直送品以外
AND    ITEM.TYPE_DIVISION <> 9 -- その他以外
AND    ITEM.SHIPPER_DIVISION <> 3 -- 油脂以外
AND    PURC.ITEM_CD = ITEM.ITEM_CD
/
COMMENT ON TABLE AP21.SIAP_CAYC IS 'ＣＡ注文書ファイル'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCCOCODE IS '会社コード( ◎ ※共通仕様参照。)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCHBRCODE IS '本支店コード(※共通仕様参照。)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCKESANKI IS '決算期(※共通仕様参照。)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCODODRNO1 IS '注文番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCHKDATE IS '発注日(YYYYMMDD)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCIMCODE IS '品目コード(20桁以内)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCHINNM IS '品目名称(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCGBUMONCD IS '原価部門コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCTACODE IS '担当者コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCKSSICODE IS '仕入先コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSINAME011 IS '仕入先名称１(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSINAME021 IS '仕入先名称２(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCODDUEDT IS '希望納期(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSTRINQTY IS '数量'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSTRINTANK IS '単価'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSTRKIN IS '金額'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCACNO IS '勘定科目コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCACHOJO IS '補助科目コード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCLOTNO IS 'ロット番号(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCODRKQTY IS '累計受入数(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSSHRQTY IS '不良数(未使用 0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCODUKEBI IS '受入完了日(発注ステータスが2:完納の場合、受入完了日(YYYYMMDD)その他のとき、0)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCODSTATUS IS '発注ステータス(0:注文書発行 1:分納 2:完納)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSPHCMT IS '摘要(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCPROJECTCD IS 'プロジェクトコード(未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCSSODRNO IS '製造オーダー番号(工程内外注用　未使用 NULL)'
/
COMMENT ON COLUMN AP21.SIAP_CAYC.YCKOUTEICD IS '工程コード(工程内外注用　未使用 NULL)'
/
