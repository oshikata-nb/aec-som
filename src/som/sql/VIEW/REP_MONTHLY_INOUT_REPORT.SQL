CREATE OR REPLACE VIEW REP_MONTHLY_INOUT_REPORT
    (KBN,LOCATION_CD,UPPER_LOCATION_CD,ITEM_CD,TARGET_MONTH,INOUT_QTY,TANTO_CD)
AS
SELECT
	M_IO_RECORD.KBN
,	M_IO_RECORD.LOCATION_CD
,	UPPER_LOCATION.UPPER_LOCATION_CD
,	M_IO_RECORD.ITEM_CD
,	M_IO_RECORD.TARGET_MONTH
,	M_IO_RECORD.INOUT_QTY
,	M_IO_RECORD.TANTO_CD

FROM
--上位ロケーション
(	SELECT
		LOCA1.LOCATION_CD
	,	CASE WHEN LOCA1.LOCATION_LEVEL = 3 
			THEN LOCA2.LOCATION_CD 
			ELSE NVL(LOCA2.UPPER_LOCATION_CD,LOCA2.LOCATION_CD) 
		END AS UPPER_LOCATION_CD 
	FROM
		LOCATION LOCA1
	,	LOCATION LOCA2
	WHERE
		NVL(LOCA1.UPPER_LOCATION_CD,LOCA1.LOCATION_CD) = LOCA2.LOCATION_CD(+)
	AND	(LOCA1.LOCATION_LEVEL = '1' OR LOCA1.LOCATION_LEVEL = '4' OR LOCA1.LOCATION_LEVEL = '3')
	AND	LOCA1.LOCATION_CD <> 'K'
)	UPPER_LOCATION

--年月、ロケーション、品目ごとの受払
,(
	--受入生産
	SELECT
		11					AS KBN			--受入生産
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)				AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		INOUT_DIVISION = 1
	OR	RY_CD = '101'
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD
	UNION

	--受入生産（預かり品）--区分:13で預り倉庫
	SELECT
		11					AS KBN			--受入生産
	,	INOUT_RECORD_WORK.LOCATION_CD
	,	INOUT_RECORD_WORK.ITEM_CD
	,	TO_CHAR(INOUT_RECORD_WORK.INOUT_DATE,'YYYYMM')	AS TARGET_MONTH
	,	SUM(INOUT_RECORD_WORK.INOUT_QTY)			AS INOUT_QTY
	,	INOUT_RECORD_WORK.TANTO_CD 
	FROM
		INOUT_RECORD_WORK
	,	(	SELECT
				LOCA1.LOCATION_CD
			,	CASE WHEN LOCA1.LOCATION_LEVEL = 3 
					THEN LOCA2.LOCATION_CD 
					ELSE NVL(LOCA2.UPPER_LOCATION_CD,LOCA2.LOCATION_CD) 
				END AS UPPER_LOCATION_CD 
			FROM
				LOCATION LOCA1
			,	LOCATION LOCA2
			WHERE
				NVL(LOCA1.UPPER_LOCATION_CD,LOCA1.LOCATION_CD) = LOCA2.LOCATION_CD(+)
			AND	(LOCA1.LOCATION_LEVEL = '1' OR LOCA1.LOCATION_LEVEL = '4' OR LOCA1.LOCATION_LEVEL = '3')
			AND	LOCA1.LOCATION_CD <> 'K'
		)	U_LOCATION

	WHERE
		U_LOCATION.LOCATION_CD = INOUT_RECORD_WORK.LOCATION_CD
	AND	INOUT_DIVISION = 13
	AND	U_LOCATION.UPPER_LOCATION_CD = 'BA'

	GROUP BY
		INOUT_RECORD_WORK.LOCATION_CD
	,	INOUT_RECORD_WORK.ITEM_CD
	,	TO_CHAR(INOUT_RECORD_WORK.INOUT_DATE,'YYYYMM')
	,	INOUT_RECORD_WORK.TANTO_CD

	UNION
	
	--受入仕入
	SELECT
		12					AS KBN			--受入仕入
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)				AS INOUT_QTY
	,	TANTO_CD 
	FROM
		INOUT_RECORD_WORK
	WHERE
		INOUT_DIVISION = 3
	OR	RY_CD = '102'
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD
	UNION
	
	--受入返品
	SELECT
		13					AS KBN			--受入返品
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)				AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		INOUT_DIVISION = 12
	OR	((RY_CD BETWEEN '900' AND '998') AND INOUT_QTY > 0)
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD
	UNION
	
	--受入移庫振替
	SELECT
		14					AS KBN			--受入移庫振替
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)				AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		RY_CD BETWEEN '104' AND '199'
	OR	(RY_CD = '501' AND INOUT_QTY > 0)
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD
	
	UNION
	
	--払出出荷
	SELECT
		21					AS KBN			--払出出荷
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		INOUT_DIVISION = 4
	OR	RY_CD = '201'
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD
	
	UNION

	--払出出荷（預かり品）--区分:13で預り倉庫以外
	SELECT
		21					AS KBN			--払出出荷
	,	INOUT_RECORD_WORK.LOCATION_CD
	,	INOUT_RECORD_WORK.ITEM_CD
	,	TO_CHAR(INOUT_RECORD_WORK.INOUT_DATE,'YYYYMM')	AS TARGET_MONTH
	,	SUM(INOUT_RECORD_WORK.INOUT_QTY)*(-1)		AS INOUT_QTY
	,	INOUT_RECORD_WORK.TANTO_CD 
	FROM
		INOUT_RECORD_WORK
	,	(	SELECT
				LOCA1.LOCATION_CD
			,	CASE WHEN LOCA1.LOCATION_LEVEL = 3 
					THEN LOCA2.LOCATION_CD 
					ELSE NVL(LOCA2.UPPER_LOCATION_CD,LOCA2.LOCATION_CD) 
				END AS UPPER_LOCATION_CD 
			FROM
				LOCATION LOCA1
			,	LOCATION LOCA2
			WHERE
				NVL(LOCA1.UPPER_LOCATION_CD,LOCA1.LOCATION_CD) = LOCA2.LOCATION_CD(+)
			AND	(LOCA1.LOCATION_LEVEL = '1' OR LOCA1.LOCATION_LEVEL = '4' OR LOCA1.LOCATION_LEVEL = '3')
			AND	LOCA1.LOCATION_CD <> 'K'
		)	U_LOCATION

	WHERE
		U_LOCATION.LOCATION_CD = INOUT_RECORD_WORK.LOCATION_CD
	AND	INOUT_DIVISION = 13
	AND	U_LOCATION.UPPER_LOCATION_CD <> 'BA'

	GROUP BY
		INOUT_RECORD_WORK.LOCATION_CD
	,	INOUT_RECORD_WORK.ITEM_CD
	,	TO_CHAR(INOUT_RECORD_WORK.INOUT_DATE,'YYYYMM')
	,	INOUT_RECORD_WORK.TANTO_CD 
	UNION
	
	--払出返品
	SELECT
		22					AS KBN			--払出返品
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD 
	FROM
		INOUT_RECORD_WORK
	WHERE
		INOUT_DIVISION <> 12
	AND	(RY_CD BETWEEN '900' AND '998') AND INOUT_QTY < 0
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD 
	
	UNION
	
	--払出工場戻し
	SELECT
		23					AS KBN			--払出工場戻し
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD 
	FROM
		INOUT_RECORD_WORK
	WHERE
		RY_CD = '202'
	OR	INOUT_DIVISION=2	--製造払出
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD 
	
	UNION
	
	--払出営業見本
	SELECT
		24					AS KBN			--払出営業見本
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		RY_CD = '204'
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD 
	
	UNION
	
	--払出移庫振替
	SELECT
		25					AS KBN			--払出移庫振替
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		RY_CD IN ('208','209','210','211','212','213')
	OR	(RY_CD = '501' AND INOUT_QTY < 0)
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD 
	
	UNION
	
	--払出その他
	SELECT
		26					AS KBN			--払出その他
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD 
	FROM
		INOUT_RECORD_WORK
	WHERE
		RY_CD IN ('205','206','207','999')
	OR	RY_CD BETWEEN '215' AND '299'
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD 

	UNION

	--払出売付
	SELECT
		27					AS KBN			--払出売付
	,	LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')		AS TARGET_MONTH
	,	SUM(INOUT_QTY)*(-1)			AS INOUT_QTY
	,	TANTO_CD
	FROM
		INOUT_RECORD_WORK
	WHERE
		RY_CD ='214'
	GROUP BY
		LOCATION_CD
	,	ITEM_CD
	,	TO_CHAR(INOUT_DATE,'YYYYMM')
	,	TANTO_CD 

)	M_IO_RECORD

WHERE
	M_IO_RECORD.LOCATION_CD = UPPER_LOCATION.LOCATION_CD
/
COMMENT ON TABLE REP_MONTHLY_INOUT_REPORT IS 'REP_受払月報（受払履歴）'
/
