CREATE OR REPLACE VIEW AP21.SIAP_CAYD
    (YDCOCODE,YDHBRCODE,YDKESANKI,YDKGETSUDO,YDTRKUBUN,YDTRSIDT,YDPYTRDNO1,
    YDGYOBAN,YDIMCODE,YDHINNM,YDGBUMONCD,YDTACODE,YDKSSICODE,YDSINAME011,
    YDSINAME021,YDODODRNO1,YDSTRINQTY,YDSTRINTANK,YDSTRKIN,YDSYHKBN,YDTRSYHKIN,
    YDODHTFLG,YDACNO,YDACHOJO,YDLOTNO,YDSPHCMT,YDTRKANNOU,YDTSKAKEDY,YDATACNO,
    YDATACHOJO,YDNODATE,YDSDENNO,YDHSMTDNO,YDHSMTGNO,YDPROJECTCD,YDSSODRNO,
    YDKOUTEICD)
AS
SELECT '001' AS YDCOCODE -- 会社コード( ◎ ※共通仕様参照。)
	  ,'001' AS YDHBRCODE -- 本支店コード(※共通仕様参照。)
	  ,'000' AS YDKESANKI -- 決算期(※共通仕様参照。)
	  ,0 AS YDKGETSUDO -- 会計月度(YYYYMM)
	  ,TO_NUMBER(ST.CATEGORY_DIVISION) AS YDTRKUBUN -- 仕入区分(0:仕入,2:返品,4:支給,6:支給返納,7:現金仕入,8:現金返品)
	  ,TO_CHAR(ST.STOCKING_DATE, 'YYYYMMDD') AS YDTRSIDT -- 仕入日付
	  ,ST.SLIP_NO AS YDPYTRDNO1 -- 仕入伝票番号
	  ,ST.ROW_NO AS YDGYOBAN -- 行番号
	  ,SUBSTR(ST.ITEM_CD, 1, 20) AS YDIMCODE -- 品目コード
	  ,NULL AS YDHINNM -- 品目名称
	  ,ST.SECTION_CD AS YDGBUMONCD -- 原価部門コード
	  ,SUBSTR(ST.TANTO_CD, 1, 6) AS YDTACODE -- 担当者コード
	  ,ST.VENDER_CD AS YDKSSICODE -- 仕入先コード
	  ,NULL AS YDSINAME011 -- 仕入先名称１
	  ,NULL AS YDSINAME021 -- 仕入先名称２
	   -- ,NULL                  AS YDODODRNO1  ,         -- 注文番号
	  ,ST.BUY_SUBCONTRACT_ORDER_NO AS YDODODRNO1 -- 注文番号
	  ,ST.STOCKING_QUANTITY * NVL(ITEM.KG_OF_FRACTION_MANAGEMENT, 0) AS YDSTRINQTY -- 数量
	   --      ,ST.HOUSING_UNITPRICE AS YDSTRINTANK -- 単価
	  ,ROUND(ST.STOCKING_AMOUNT /
			 DECODE((ST.STOCKING_QUANTITY *
					NVL(ITEM.KG_OF_FRACTION_MANAGEMENT, 0))
				   ,0
				   ,1
				   ,(ST.STOCKING_QUANTITY *
					NVL(ITEM.KG_OF_FRACTION_MANAGEMENT, 0)))
			,4) AS YDSTRINTANK -- 単価
	  ,ST.STOCKING_AMOUNT AS YDSTRKIN -- 金額
	  ,0 AS YDSYHKBN -- 消費税区分
	  ,0 AS YDTRSYHKIN -- 消費税額
	  ,0 AS YDODHTFLG -- 仮単価ＦＬＧ
	  ,ST.TITLE_CD AS YDACNO -- 勘定科目コード
	  ,'0000000000' AS YDACHOJO -- 補助科目コード
	  ,NULL AS YDLOTNO -- ロット番号
	  ,NULL AS YDSPHCMT -- 摘要
	   --    ,ST.DELIVERY_COMP AS YDTRKANNOU -- 完納区分(0:未完,1:完納)
	  ,1                AS YDTRKANNOU -- 完納区分(0:未完,1:完納)
	  ,0                AS YDTSKAKEDY -- 買掛更新日付
	  ,NULL             AS YDATACNO -- 相手勘定科目コード
	  ,NULL             AS YDATACHOJO -- 相手補助科目コード
	  ,ST.ACCOUNT_YEARS AS YDNODATE -- 処理年月度
	  ,NULL             AS YDSDENNO -- 仕訳伝票番号
	  ,NULL             AS YDHSMTDNO -- 発生元伝票番号
	  ,0                AS YDHSMTGNO -- 発生元伝票番号行番号
	  ,NULL             AS YDPROJECTCD -- プロジェクトコード
	  ,ST.DIRECTION_NO  AS YDSSODRNO -- 製造オーダー番号
	  ,ST.OPERATION_CD  AS YDKOUTEICD -- 工程コード:工程外注の場合の工程コード';
FROM   (SELECT P.BUY_SUBCONTRACT_ORDER_NO -- 発注番号
			  ,P.STOCKING_DATE AS STOCKING_DATE -- 仕入日付
			  ,P.SLIP_NO -- 伝票番号
			  ,1 AS ROW_NO -- 伝票番号行番号( 仕入は１しかない。)
			  ,TO_CHAR(P.ITEM_CD) AS ITEM_CD -- 品目コード
			  ,NVL(TANTO_CD, P.INPUTOR_CD) AS TANTO_CD -- 担当者コード 
			  ,'SI' || P.VENDER_CD AS VENDER_CD -- 仕入先コード
			  ,TO_CHAR(P.CREDIT_TITLE_CD) AS TITLE_CD -- 貸方勘定科目
			  ,TO_CHAR(NVL(P.ACCOUNT_CREDIT_SECTION_CD
						  ,NVL((SELECT SECTION_CD
							   FROM   AP21.PURCHASE_ATTRIBUTE_QUEUE Q
									 ,AP21.ITEM                     I
							   WHERE  I.ITEM_CD = P.ITEM_CD
							   AND    I.ITEM_CD = Q.ITEM_CD
							   AND    I.VERSION = Q.VERSION)
							  ,'0101'))) AS SECTION_CD -- 部門コード
			  ,DECODE(P.BUY_SUBCONTRACT_ORDER_NO
					 ,NULL
					 ,(SELECT SUM(STOCKING_QUANTITY)
					  FROM   PURCHASE_SUBCONTRACT
					  WHERE  PURCHASE_NO = P.PURCHASE_NO
					  GROUP  BY BUY_SUBCONTRACT_ORDER_NO
							   ,NVL(ORDER_DIVIDE_NO, '000'))
					 ,(SELECT SUM(STOCKING_QUANTITY)
					  FROM   PURCHASE_SUBCONTRACT
					  WHERE  BUY_SUBCONTRACT_ORDER_NO =
							 P.BUY_SUBCONTRACT_ORDER_NO
					  AND    NVL(ORDER_DIVIDE_NO, '000') =
							 NVL(P.ORDER_DIVIDE_NO, '000')
					  GROUP  BY BUY_SUBCONTRACT_ORDER_NO
							   ,NVL(ORDER_DIVIDE_NO, '000'))) STOCKING_QUANTITY -- 仕入数量
			   
			  ,DECODE(P.BUY_SUBCONTRACT_ORDER_NO
					 ,NULL
					 ,(SELECT SUM(HOUSING_UNITPRICE)
					  FROM   PURCHASE_SUBCONTRACT
					  WHERE  PURCHASE_NO = P.PURCHASE_NO
					  GROUP  BY BUY_SUBCONTRACT_ORDER_NO
							   ,NVL(ORDER_DIVIDE_NO, '000'))
					 ,(SELECT SUM(HOUSING_UNITPRICE)
					  FROM   PURCHASE_SUBCONTRACT
					  WHERE  BUY_SUBCONTRACT_ORDER_NO =
							 P.BUY_SUBCONTRACT_ORDER_NO
					  AND    NVL(ORDER_DIVIDE_NO, '000') =
							 NVL(P.ORDER_DIVIDE_NO, '000')
					  GROUP  BY BUY_SUBCONTRACT_ORDER_NO
							   ,NVL(ORDER_DIVIDE_NO, '000'))) HOUSING_UNITPRICE -- 仕入単価
			   
			  ,DECODE(P.BUY_SUBCONTRACT_ORDER_NO
					 ,NULL
					 ,(SELECT SUM(STOCKING_AMOUNT)
					  FROM   PURCHASE_SUBCONTRACT
					  WHERE  PURCHASE_NO = P.PURCHASE_NO
					  GROUP  BY BUY_SUBCONTRACT_ORDER_NO
							   ,NVL(ORDER_DIVIDE_NO, '000'))
					 ,(SELECT SUM(STOCKING_AMOUNT)
					  FROM   PURCHASE_SUBCONTRACT
					  WHERE  BUY_SUBCONTRACT_ORDER_NO =
							 P.BUY_SUBCONTRACT_ORDER_NO
					  AND    NVL(ORDER_DIVIDE_NO, '000') =
							 NVL(P.ORDER_DIVIDE_NO, '000')
					  GROUP  BY BUY_SUBCONTRACT_ORDER_NO
							   ,NVL(ORDER_DIVIDE_NO, '000'))) STOCKING_AMOUNT -- 仕入金額
			   
			  ,TO_NUMBER(P.DELIVERY_COMP) AS DELIVERY_COMP -- 完納区分(0:未完,1:完納)
			   -- 分類コード
			  ,DECODE(P.CATEGORY_DIVISION
					 ,1
					 ,0
					 ,2
					 ,2
					 ,3
					 ,8
					 ,4
					 ,7
					 ,-1
					 ,8
					 ,-2
					 ,7
					 ,-3
					 ,7
					 ,8) AS CATEGORY_DIVISION
			   -- 勘定年月
			  ,NVL(TO_CHAR(TO_DATE(P.ACCOUNT_YEARS, 'YYYYMM'), 'YYYYMM')
				  ,NVL(TO_CHAR(P.PAYABLE_UPDATE_DATE, 'YYYYMM')
					  ,TO_CHAR(P.STOCKING_DATE, 'YYYYMM'))) AS ACCOUNT_YEARS
			  ,NULL AS DIRECTION_NO -- 指図書番号
			  ,NULL AS OPERATION_CD -- 工程(10:調合,30:包装)
		FROM   AP21.PURCHASE_SUBCONTRACT P
			  ,AP21.ITEM_QUEUE
			  ,(SELECT ITEM_CD, MAX(VERSION) VERSION
				FROM   AP21.ITEM_QUEUE
				GROUP  BY ITEM_CD) MAX_ITEM_QUEUE
		WHERE  STATUS2 = 3 -- 承認済み
		AND    P.ROW_NO IN (1, 1001) --仕入番号の１行目だけに絞る（消費税が全行に入っているため）
		AND    P.STOCKING_AMOUNT <> 0
			  --    AND    ITEM_QUEUE.TYPE_DIVISION <> 4 -- 仕入直送品以外
		AND    ITEM_QUEUE.TYPE_DIVISION <> 9 -- その他以外
		AND    ITEM_QUEUE.SHIPPER_DIVISION <> 3 -- 油脂以外
		AND    P.ITEM_CD = ITEM_QUEUE.ITEM_CD
		AND    ITEM_QUEUE.ITEM_CD = MAX_ITEM_QUEUE.ITEM_CD
		AND    ITEM_QUEUE.VERSION = MAX_ITEM_QUEUE.VERSION) ST
	  ,AP21.ITEM
WHERE  ST.ITEM_CD = ITEM.ITEM_CD(+)
/
COMMENT ON TABLE AP21.SIAP_CAYD IS 'ＣＡ仕入ファイル'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDCOCODE IS '会社コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDHBRCODE IS '本支店コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDKESANKI IS '決算期'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDKGETSUDO IS '会計月度'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDTRKUBUN IS '仕入区分'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDTRSIDT IS '仕入日付'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDPYTRDNO1 IS '仕入伝票番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDGYOBAN IS '行番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDIMCODE IS '品目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDHINNM IS '品目名称'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDGBUMONCD IS '原価部門コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDTACODE IS '担当者コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDKSSICODE IS '仕入先コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSINAME011 IS '仕入先名称１'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSINAME021 IS '仕入先名称２'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDODODRNO1 IS '注文番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSTRINQTY IS '数量'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSTRINTANK IS '単価'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSTRKIN IS '金額'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSYHKBN IS '消費税区分'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDTRSYHKIN IS '消費税額'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDODHTFLG IS '仮単価ＦＬＧ'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDACNO IS '勘定科目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDACHOJO IS '補助科目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDLOTNO IS 'ロット番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSPHCMT IS '摘要'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDTRKANNOU IS '完納区分'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDTSKAKEDY IS '買掛更新日付'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDATACNO IS '相手勘定科目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDATACHOJO IS '相手補助科目コード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDNODATE IS '処理年月度'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSDENNO IS '仕訳伝票番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDHSMTDNO IS '発生元伝票番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDHSMTGNO IS '発生元伝票番号行番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDPROJECTCD IS 'プロジェクトコード'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDSSODRNO IS '製造オーダー番号'
/
COMMENT ON COLUMN AP21.SIAP_CAYD.YDKOUTEICD IS '工程コード:工程外注の場合の工程コード'
/
