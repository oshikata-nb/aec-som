CREATE OR REPLACE TRIGGER CARRY_IF_TRIGGER
AFTER INSERT OR DELETE OR UPDATE OF FLAN_TRANS_SHOP_CD,CARRY_NAME1,CARRY_CD
ON CARRY
REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW 
DECLARE
	TEMP_COUNT 		NUMBER;
	TEMP_PROC_DIVISION 	NUMBER;			-- 処理区分
	CONST_INSERT 		NUMBER := 1;		-- レコード追加処理
	CONST_UPDATE 		NUMBER := 2;		-- レコード更新処理
	CONST_DELETE 		NUMBER := 3;		-- レコード削除処理
	TEMP_PRIMARY_KEY	VARCHAR2(20);		-- 主キー
	CONST_SPACE 		VARCHAR(10) := ' ';	-- スペース

BEGIN

	IF (INSERTING) THEN	-- 新規追加時
		TEMP_PROC_DIVISION := CONST_INSERT;
		TEMP_PRIMARY_KEY := :NEW.CARRY_CD;
	END IF;
	IF (UPDATING) THEN	-- 更新時
		TEMP_PROC_DIVISION := CONST_UPDATE;
		TEMP_PRIMARY_KEY := :NEW.CARRY_CD;
	END IF;
	IF (DELETING) THEN	-- 削除時
		TEMP_PROC_DIVISION := CONST_DELETE;
		TEMP_PRIMARY_KEY := :OLD.CARRY_CD;
	END IF;

	SELECT COUNT(*) INTO TEMP_COUNT FROM IF_MASTER_UNSOTEN WHERE IF_MASTER_UNSOTEN.UNSOTENCODE = TEMP_PRIMARY_KEY;
	
	IF TEMP_COUNT <> 0 THEN

		UPDATE IF_MASTER_UNSOTEN SET 
			UNSOTENMEI = NVL(:NEW.CARRY_NAME1,CONST_SPACE),
			UNSOTENKIGO = NVL(:NEW.FLAN_TRANS_SHOP_CD,CONST_SPACE),
			PROC_DIVISION =TEMP_PROC_DIVISION 
		WHERE IF_MASTER_UNSOTEN.UNSOTENCODE = TEMP_PRIMARY_KEY;

	ELSE
		
		INSERT INTO IF_MASTER_UNSOTEN VALUES(
			TEMP_PRIMARY_KEY,
			NVL(:NEW.CARRY_NAME1,CONST_SPACE),
			NVL(:NEW.FLAN_TRANS_SHOP_CD,CONST_SPACE),
			TEMP_PROC_DIVISION
		);
		
	END IF;
-- 異常処理
EXCEPTION
	WHEN OTHERS THEN

		OUTPUT_ERROR_LOG('CARRY','TRIGGER',SQLCODE,SQLERRM);

END;
/
