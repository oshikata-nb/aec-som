CREATE OR REPLACE TRIGGER ITEM_SEIHIN_TRIGGER
AFTER INSERT OR DELETE OR UPDATE OF ITEM_SUB_NAME,OTHER_COMPANY_CD1,STYLE_OF_PACKING,TYPE_DIVISION,ITEM_NAME,KG_OF_FRACTION_MANAGEMENT,ITEM_CD
ON ITEM
REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW 
DECLARE
	TEMP_COUNT 		NUMBER;
	TEMP_PROC_DIVISION 	NUMBER;			-- 処理区分
	CONST_INSERT 		NUMBER := 1;		-- レコード追加処理
	CONST_UPDATE 		NUMBER := 2;		-- レコード更新処理
	CONST_DELETE 		NUMBER := 3;		-- レコード削除処理
	TEMP_PRIMARY_KEY	VARCHAR2(20);		-- 主キー
	CONST_SPACE 		VARCHAR(10) := ' ';	-- スペース
	CONST_ZERO 		NUMBER := 0;		-- ゼロ値

	CONST_GENZAIRYO 	NUMBER := 1;		-- 種別原材料
	CONST_HOUZAI 		NUMBER := 2;		-- 種別包材

BEGIN

	IF (INSERTING) THEN	-- 新規追加時

		-- 新規時原材料＆包材以外の場合処理を行う
		IF :NEW.TYPE_DIVISION = CONST_GENZAIRYO OR :NEW.TYPE_DIVISION = CONST_HOUZAI THEN
			RETURN;
		ELSE
			TEMP_PROC_DIVISION := CONST_INSERT;
			TEMP_PRIMARY_KEY := :NEW.ITEM_CD;
		END IF;
	END IF;
	IF (UPDATING) THEN	-- 更新時
		-- 更新時以前のレコードの種別も見る
		IF :OLD.TYPE_DIVISION <> CONST_GENZAIRYO AND :OLD.TYPE_DIVISION <> CONST_HOUZAI THEN	-- 更新前が原材料＆包材の場合
			
			IF :NEW.TYPE_DIVISION <> CONST_GENZAIRYO AND :NEW.TYPE_DIVISION <> CONST_HOUZAI THEN
				-- 更新前が原材料＆包材以外の場合　かつ　更新後が原材料＆包材以外の場合（更新）
				TEMP_PROC_DIVISION := CONST_UPDATE;
				TEMP_PRIMARY_KEY := :NEW.ITEM_CD;
			ELSE
				-- 更新前が原材料＆包材以外の場合　かつ　更新後が原材料＆包材の場合（削除）
				TEMP_PROC_DIVISION := CONST_DELETE;
				TEMP_PRIMARY_KEY := :NEW.ITEM_CD;
			END IF;
		ELSE
			IF :NEW.TYPE_DIVISION <> CONST_GENZAIRYO AND :NEW.TYPE_DIVISION <> CONST_HOUZAI THEN
				-- 更新前が原材料＆包材で　かつ　更新後がが原材料＆包材以外の場合（新規）
				TEMP_PROC_DIVISION := CONST_INSERT;
				TEMP_PRIMARY_KEY := :NEW.ITEM_CD;
			ELSE
				-- 更新前が原材料＆包材以外で　かつ　更新後が原材料＆包材以外の場合（処理無し）
				RETURN;
				
			END IF;
		END IF;
	END IF;
	IF (DELETING) THEN	-- 削除時
		-- 新規時原材料＆包材以外の場合のみ処理
		IF :OLD.TYPE_DIVISION <> CONST_GENZAIRYO AND :OLD.TYPE_DIVISION <> CONST_HOUZAI THEN
			TEMP_PROC_DIVISION := CONST_DELETE;
			TEMP_PRIMARY_KEY := :OLD.ITEM_CD;
		ELSE
			RETURN;
		END IF;
	END IF;
	
	-- 製造品扱い
	
	
	
	SELECT COUNT(*) INTO TEMP_COUNT FROM IF_MASTER_SEIHIN WHERE IF_MASTER_SEIHIN.SEIHINCODE = TEMP_PRIMARY_KEY;
	
	IF TEMP_COUNT <> 0 THEN

		UPDATE IF_MASTER_SEIHIN SET 
			DAISEICODE = NVL(:NEW.PARENT_ITEM_CD,CONST_SPACE),	-- 代表製品コード
			DAISEIMEI = NVL(:NEW.ITEM_NAME,CONST_SPACE),		-- 代表製品名
			SEIHINCODE = NVL(:NEW.ITEM_CD,CONST_SPACE),		-- 製品コード
			SEIHINMEI = NVL(:NEW.ITEM_NAME,CONST_SPACE),		-- 品目名称
			SEIHINKANA = NVL(:NEW.ITEM_SUB_NAME,CONST_SPACE),	-- セ品カナ
			NISUGATA = NVL(:NEW.STYLE_OF_PACKING,CONST_SPACE),	-- 荷姿
			KGKANZANCHI = NVL(:NEW.KG_OF_FRACTION_MANAGEMENT,CONST_SPACE),	-- KG換算値
			IOCODE= NVL(:NEW.OTHER_COMPANY_CD1,CONST_SPACE),		-- 他社コード1
			PROC_DIVISION =TEMP_PROC_DIVISION
		WHERE IF_MASTER_SEIHIN.SEIHINCODE = TEMP_PRIMARY_KEY;

	ELSE
		
		INSERT INTO IF_MASTER_SEIHIN VALUES(
			NVL(:NEW.ITEM_CD,CONST_SPACE),	-- 代表製品コード
			NVL(:NEW.ITEM_NAME,CONST_SPACE),-- 代表製品名
			NVL(:NEW.ITEM_CD,CONST_SPACE),	-- 製品コード
			CONST_SPACE,			-- 商品区分
			NVL(:NEW.ITEM_NAME,CONST_SPACE),-- 製品名
			NVL(:NEW.ITEM_SUB_NAME,CONST_SPACE),	-- 製品カナ名称
			CONST_SPACE,			-- 振替製品コード
			NVL(:NEW.STYLE_OF_PACKING,CONST_SPACE),	-- 荷姿
			CONST_SPACE,			-- 製品管理区分
			NVL(:NEW.KG_OF_FRACTION_MANAGEMENT,CONST_SPACE),	-- ＫＧ換算値
			CONST_SPACE,			-- 総重量
			CONST_SPACE,			-- 入数
			CONST_SPACE,			-- 工場コード
			CONST_SPACE,			-- 検査日数
			CONST_SPACE,			-- 製品分類
			CONST_SPACE,			-- ＯＥＭ先コード
			CONST_SPACE,			-- 納入先拠点コード
			CONST_SPACE,			-- ロット区分
			CONST_SPACE,			-- 調合タンクＮｏ．1
			CONST_SPACE,			-- 調合タンクＮｏ．2
			CONST_SPACE,			-- 調合タンクＮｏ．3
			CONST_SPACE,			-- 最初包装ライン1
			CONST_SPACE,			-- 最初包装ライン2
			CONST_SPACE,			-- 最初包装ライン3
			CONST_SPACE,			-- 後包装ライン
			CONST_SPACE,			-- 最大調合時間
			CONST_SPACE,			-- 最大製造量
			CONST_SPACE,			-- 最小調合時間
			CONST_SPACE,			-- 最小製造量
			CONST_SPACE,			-- 調合検査時間
			CONST_SPACE,			-- 移送時間
			CONST_SPACE,			-- 前準備時間
			CONST_SPACE,			-- 包装時間
			CONST_SPACE,			-- 後包装時間
			CONST_SPACE,			-- 後始末時間
			CONST_SPACE,			-- (将来)OEM先
			CONST_SPACE,			-- パレット上製品数
			CONST_SPACE,			-- 種別
			NVL(:NEW.OTHER_COMPANY_CD1,CONST_SPACE),	-- I/Oコード
			CONST_SPACE,			-- 外注加工品
			CONST_SPACE,			-- 外注先名
			CONST_SPACE,			-- 比重
			CONST_SPACE,			-- 歩留まり
			CONST_SPACE,			-- 包装指図書分類
			CONST_SPACE,			-- ミキシング回数
			CONST_SPACE,			-- ドライエージング時間
			TEMP_PROC_DIVISION		-- 処理区分
		);
		
	END IF;
-- 異常処理
EXCEPTION
	WHEN OTHERS THEN

		OUTPUT_ERROR_LOG('ITEM_GENZAIRYO','TRIGGER',SQLCODE,SQLERRM);

END;
/
