CREATE OR REPLACE PROCEDURE      DEL_PRODUCTION_PLAN

IS
	ERR_CODE 	VARCHAR2(100);
	ERR_MSG 	VARCHAR2(2048);

	-- 製造計画.製造状況 = [2:完了]で検索
    	CURSOR remote_delete IS SELECT SEIZOSASHIZUNO FROM KEIKAKU_SEIZO WHERE KEIKAKU_SEIZO.SEIZOJOKYO = 2;
BEGIN

	-- 製造指示.製造指図書No = 製造計画.製造指図番号のものを削除
   	FOR rec IN remote_delete LOOP
		DELETE FROM SIJI_SEIZO WHERE SEIZOSASHIZUNO = rec.SEIZOSASHIZUNO ;
	END LOOP;

	-- 製造計画.製造状況 = [2:完了]を削除
	DELETE FROM KEIKAKU_SEIZO WHERE KEIKAKU_SEIZO.SEIZOJOKYO = 2;

	COMMIT;

-- 異常処理
EXCEPTION

	WHEN OTHERS THEN

		-- SQLエラーコード、エラーメッセージを取得
	    	ERR_CODE := SQLCODE;
		ERR_MSG  := SUBSTR(SQLERRM,1,1024);

		ROLLBACK;

		INSERT INTO ERROR_LOG (
			MODULE_CD,
			CLIENT,
			ERROR_DATE,
			ERROR_MES,
			SQL_STR
		) VALUES (
			'DEL_PRODUCTION_PLAN',
			'AUTO',
			SYSDATE,
			ERR_CODE,
			ERR_MSG
		);
END;
/
