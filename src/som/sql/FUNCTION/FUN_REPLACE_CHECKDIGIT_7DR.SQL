CREATE OR REPLACE FUNCTION FUN_REPLACE_CHECKDIGIT_7DR
(BASE_STR VARCHAR2
, BC_CHECKDIGIT_START NUMBER
, BC_CHECKDIGIT_END NUMBER ) RETURN VARCHAR2 IS
--■■■■■■■■■■■■■■■■■■■
--■　チェックディジット計算処理
--■　BASE_STR           :基本文字列 @を計算結果で置換
--■　BC_CHECKDIGIT_START:チェックディジット計算開始桁
--■　BC_CHECKDIGIT_END  :チェックディジット計算終了桁
--■■■■■■■■■■■■■■■■■■■
	CHECKDIGIT NUMBER(1);
    CALC_BASE_STR VARCHAR2(50);
    O_ERROR_RETURN_MSG VARCHAR2(1000);
BEGIN

    -- 置換対象がない場合、終了
    IF BC_CHECKDIGIT_START IS NULL 
        OR BC_CHECKDIGIT_END IS NULL 
        OR INSTR( BASE_STR , '@' ) = 0 THEN
        RETURN BASE_STR;
    END IF;

    -- 計算対象文字列の取得
    CALC_BASE_STR := SUBSTR( BASE_STR , BC_CHECKDIGIT_START , LENGTH( BASE_STR ) - ( LENGTH( BASE_STR ) - BC_CHECKDIGIT_END + ( BC_CHECKDIGIT_START - 1 )  )  );

    -- 計算対象が数値でない場合、終了
    IF TO_NUMBER2( CALC_BASE_STR ) IS NULL THEN
        RETURN BASE_STR;
    END IF;

    -- チェックディジットを計算
    CHECKDIGIT := MOD( TO_NUMBER( CALC_BASE_STR ) , 7 );

    RETURN REPLACE( BASE_STR , '@' , CHECKDIGIT );

EXCEPTION
		WHEN OTHERS THEN
		-- SQLエラーコード、エラーメッセージを取得
	    O_ERROR_RETURN_MSG  := SUBSTR(SQLERRM,1,1024);
		OUTPUT_ERROR_LOG('FUN_REPLACE_CHECKDIGIT_7DR','7DR',BASE_STR, SUBSTR( O_ERROR_RETURN_MSG , 0 , 1000 ));
	RETURN BASE_STR;
END;
/
