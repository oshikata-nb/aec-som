CREATE OR REPLACE PROCEDURE      TESTKOUBAI1
IS
I_INVENTORY NUMBER :=0;
I_BACKORDER NUMBER:=0;
I_ASSIGN_QTY NUMBER:=0;
I_SALES NUMBER:=0;
I_FINISH NUMBER:=0;
I_INSPECTION NUMBER:=0;
L_INVENTORY NUMBER:=0;
L_BACKORDER NUMBER:=0;
L_ASSIGN_QTY NUMBER:=0;
L_SALES NUMBER:=0;
L_FINISH NUMBER:=0;
L_INSPECTION NUMBER:=0;
LL_INVENTORY NUMBER:=0;
LL_BACKORDER NUMBER:=0;
LL_ASSIGN_QTY NUMBER:=0;
LL_SALES NUMBER:=0;
LL_FINISH NUMBER:=0;
LL_INSPECTION NUMBER:=0;
O_INVENTORY NUMBER:=0;
O_BACKORDER NUMBER:=0;
O_ASSIGN_QTY NUMBER:=0;
O_SALES NUMBER:=0;
O_FINISH NUMBER:=0;
O_INSPECTION NUMBER:=0;
O_QTY NUMBER:=0;
O_FLG NUMBER:=0;
STR_IND NVARCHAR2(20):='';
CT NUMBER:=0;
para NVARCHAR2(1024):='';
ID NVARCHAR2(20):='';
BEGIN
INSERT INTO PURCHASE_SUBCONTRACT VALUES (
'TESTDATA001','TESTDATA001',null,'JU00000004',null,null,0,null,TO_DATE('2009/04/01','yyyy/mm/dd'),
'01001','01001','som',0,null,'00000087',null,100,1000,100,null,100,TO_DATE('2009/04/01','yyyy/mm/dd'),
'kkk','kkk','kk','G3',2,null,null,TO_DATE('2009/04/01','yyyy/mm/dd'),null,0,null,0,null,0,0,null,null,null,null,0,null,0,null,
'999999','G3','K',100,1,30,300,5,25,1,1,26,TO_DATE('2009/04/01','yyyy/mm/dd'),null,null,null,null,0,0,null,null,null,null,null,null,
null,0,0,0,null,0,null,null,null,null,null,null,null,null,null,0,0,0,0,0,0,0,0,0,0,0,0,null,0,0,null,0,0,0,null,0,null,
null,SYSDATE,'som',SYSDATE,'som' );
SELECT PURCHASE_NO INTO ID FROM PURCHASE_SUBCONTRACT WHERE BUY_SUBCONTRACT_ORDER_NO = 'TESTDATA001' AND ORDER_DIVIDE_NO IS NULL;
select COUNT(*) 
INTO CT 
FROM ITEM_INVENTORY 
WHERE ITEM_CD = '00000087' 
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO I_INVENTORY,I_BACKORDER,I_ASSIGN_QTY,I_SALES,I_FINISH,I_INSPECTION 
FROM ITEM_INVENTORY 
WHERE ITEM_CD = '00000087' 
;
END IF;
select COUNT(*) 
INTO CT 
FROM LOCATION_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3'
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO L_INVENTORY,L_BACKORDER,L_ASSIGN_QTY,L_SALES,L_FINISH,L_INSPECTION 
FROM LOCATION_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3'
;
END IF;
select COUNT(*) 
INTO CT 
FROM LOT_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3' AND LOT_NO = '999999'
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO LL_INVENTORY,LL_BACKORDER,LL_ASSIGN_QTY,LL_SALES,LL_FINISH,LL_INSPECTION 
FROM LOT_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3' AND LOT_NO = '999999'
;
END IF;
DELETE INOUT_SOURCE WHERE ODER_NO = 'TESTDATA001' AND ODER_LINE_NO = 0;

/* INOUT_SOURCE 作成 */
	DBMS_OUTPUT.PUT_LINE('登録');
 ZAIKOUKEHARAI.ENTRY_PURCHASE(1,ID,'som',para);
 IF para = 'COMPLETE' THEN NULL;ELSE GOTO P_END;END IF;
SELECT COUNT(*) INTO CT FROM INOUT_SOURCE WHERE ODER_NO = 'TESTDATA001' AND ODER_LINE_NO = 0;
IF CT = 1 THEN 
	NULL;
ELSE
	para :='ENTRY_PURCHASE(1,TESTDATA001,som,para); not Create INOUT_SOURCE';
	GOTO P_END;
END IF;
SELECT INOUT_SOURCE_NO  INTO STR_IND FROM INOUT_SOURCE WHERE ODER_NO = 'TESTDATA001' AND ODER_LINE_NO = 0;
SELECT INOUT_QTY,ASSIGN_FLAG INTO O_QTY,O_FLG FROM INOUT_SOURCE WHERE INOUT_SOURCE_NO  = STR_IND; 
IF O_QTY = 100 AND O_FLG = 0 THEN
	NULL;
ELSE
	para :='ENTRY_PURCHASE(1,TESTDATA001,som,para); ' || TO_CHAR(O_QTY) || ',' || TO_CHAR(O_FLG);
	GOTO P_END;
END IF;
	DBMS_OUTPUT.PUT_LINE('QTY = ' || TO_CHAR(O_QTY) || ' FLG = ' || TO_CHAR(O_FLG));

/* INOUT_SOURCE 引当済み　品目在庫　引当 */
	DBMS_OUTPUT.PUT_LINE('伝票発行');
 ZAIKOUKEHARAI.ENTRY_PURCHASE(3,ID,'som',para);
 IF para = 'COMPLETE' THEN NULL;ELSE GOTO P_END;END IF;
SELECT COUNT(*) INTO CT FROM INOUT_SOURCE WHERE ODER_NO = 'TESTDATA001' AND ODER_LINE_NO = 0;
IF CT = 1 THEN 
	NULL;
ELSE
	para :='2ENTRY_PURCHASE(3,TESTDATA001,som,para); not Create INOUT_SOURCE';
	GOTO P_END;
END IF;
SELECT INOUT_QTY,ASSIGN_FLAG INTO O_QTY,O_FLG FROM INOUT_SOURCE WHERE INOUT_SOURCE_NO  = STR_IND; 
IF O_QTY = 100 AND O_FLG = 1 THEN
	NULL;
ELSE
	para :='ENTRY_PURCHASE(3,TESTDATA001,som,para); ' || TO_CHAR(O_QTY) || ',' || TO_CHAR(O_FLG);
	GOTO P_END;
END IF;
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO O_INVENTORY,O_BACKORDER,O_ASSIGN_QTY,O_SALES,O_FINISH,O_INSPECTION 
FROM ITEM_INVENTORY 
WHERE ITEM_CD = '00000087' 
;
	DBMS_OUTPUT.PUT_LINE('QTY = ' || TO_CHAR(O_QTY) || ' FLG = ' || TO_CHAR(O_FLG) || ' INV = ' || TO_CHAR(O_INVENTORY) || ' BACK = ' || TO_CHAR(O_BACKORDER));
IF O_INVENTORY = I_INVENTORY AND O_BACKORDER = I_BACKORDER + 100 AND O_ASSIGN_QTY = I_ASSIGN_QTY 
   AND O_SALES = I_SALES AND O_FINISH = I_FINISH AND O_INSPECTION = I_INSPECTION THEN
   NULL;
ELSE
	para :='ENTRY_PURCHASE(3,TESTDATA001,som,para); ' || TO_CHAR(O_BACKORDER) || '<>' || TO_CHAR(I_BACKORDER + 100) ;
	GOTO P_END;
END IF;
select COUNT(*) 
INTO CT 
FROM LOCATION_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3'
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO O_INVENTORY,O_BACKORDER,O_ASSIGN_QTY,O_SALES,O_FINISH,O_INSPECTION 
FROM LOCATION_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3'
;
IF O_INVENTORY = L_INVENTORY AND O_BACKORDER = L_BACKORDER  AND O_ASSIGN_QTY = L_ASSIGN_QTY 
   AND O_SALES = L_SALES AND O_FINISH = L_FINISH AND O_INSPECTION = L_INSPECTION THEN
   NULL;
ELSE
	para :='ENTRY_PURCHASE(3,TESTDATA001,som,para); ILLIGAL CREATE LOCATION_INV'  ;
	GOTO P_END;
END IF;
END IF;
select COUNT(*) 
INTO CT 
FROM LOT_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3' AND LOT_NO = '999999'
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO O_INVENTORY,O_BACKORDER,O_ASSIGN_QTY,O_SALES,O_FINISH,O_INSPECTION 
FROM LOT_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3' AND LOT_NO = '999999'
;
IF O_INVENTORY = LL_INVENTORY AND O_BACKORDER = LL_BACKORDER  AND O_ASSIGN_QTY = LL_ASSIGN_QTY 
   AND O_SALES = LL_SALES AND O_FINISH = LL_FINISH AND O_INSPECTION = LL_INSPECTION THEN
   NULL;
ELSE
	para :='ENTRY_PURCHASE(3,TESTDATA001,som,para); ILLIGAL CREATE LOT_INV'  ;
	GOTO P_END;
END IF;
END IF;

/* INOUT_SOURCE 未引当　品目在庫　ー */
	DBMS_OUTPUT.PUT_LINE('伝票発行取消');
 ZAIKOUKEHARAI.ENTRY_PURCHASE(4,ID,'som',para);
 IF para = 'COMPLETE' THEN NULL;ELSE GOTO P_END;END IF;
SELECT COUNT(*) INTO CT FROM INOUT_SOURCE WHERE ODER_NO = 'TESTDATA001' AND ODER_LINE_NO = 0;
IF CT = 1 THEN 
	NULL;
ELSE
	para :='ENTRY_PURCHASE(4,TESTDATA001,som,para); not Create INOUT_SOURCE';
	GOTO P_END;
END IF;
SELECT INOUT_QTY,ASSIGN_FLAG INTO O_QTY,O_FLG FROM INOUT_SOURCE WHERE INOUT_SOURCE_NO  = STR_IND; 
IF O_QTY = 100 AND O_FLG = 0 THEN
	NULL;
ELSE
	para :='ENTRY_PURCHASE(4,TESTDATA001,som,para); ' || TO_CHAR(O_QTY) || ',' || TO_CHAR(O_FLG);
	GOTO P_END;
END IF;
select COUNT(*) 
INTO CT 
FROM ITEM_INVENTORY 
WHERE ITEM_CD = '00000087' 
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO O_INVENTORY,O_BACKORDER,O_ASSIGN_QTY,O_SALES,O_FINISH,O_INSPECTION 
FROM ITEM_INVENTORY 
WHERE ITEM_CD = '00000087' 
;
ELSE
	O_INVENTORY:=0;
	O_BACKORDER:=0;
	O_ASSIGN_QTY:=0;
	O_SALES:=0;
	O_FINISH:=0;
	O_INSPECTION:=0;
END IF;
	DBMS_OUTPUT.PUT_LINE('QTY = ' || TO_CHAR(O_QTY) || ' FLG = ' || TO_CHAR(O_FLG) || ' INV = ' || TO_CHAR(O_INVENTORY) || ' BACK = ' || TO_CHAR(O_BACKORDER));
IF O_INVENTORY = I_INVENTORY AND O_BACKORDER = I_BACKORDER AND O_ASSIGN_QTY = I_ASSIGN_QTY 
   AND O_SALES = I_SALES AND O_FINISH = I_FINISH AND O_INSPECTION = I_INSPECTION THEN
   NULL;
ELSE
	para :='ENTRY_PURCHASE(4,TESTDATA001,som,para); ' || TO_CHAR(O_BACKORDER) || '<>' || TO_CHAR(I_BACKORDER + 100) ;
	GOTO P_END;
END IF;
select COUNT(*) 
INTO CT 
FROM LOCATION_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3'
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO O_INVENTORY,O_BACKORDER,O_ASSIGN_QTY,O_SALES,O_FINISH,O_INSPECTION 
FROM LOCATION_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3'
;
IF O_INVENTORY = L_INVENTORY AND O_BACKORDER = L_BACKORDER  AND O_ASSIGN_QTY = L_ASSIGN_QTY 
   AND O_SALES = L_SALES AND O_FINISH = L_FINISH AND O_INSPECTION = L_INSPECTION THEN
   NULL;
ELSE
	para :='ENTRY_PURCHASE(4,TESTDATA001,som,para); ILLIGAL CREATE LOCATION_INV'  ;
	GOTO P_END;
END IF;
END IF;
select COUNT(*) 
INTO CT 
FROM LOT_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3' AND LOT_NO = '999999'
;
IF CT = 1 THEN
select NVL(INVENTORY_QTY,0),NVL(BACKORDER_QTY,0),NVL(ASSIGN_QTY,0),NVL(SALES_ASSIGN_QTY,0),NVL(FINISH_QTY,0),NVL(INSPECTION_QTY,0) 
INTO O_INVENTORY,O_BACKORDER,O_ASSIGN_QTY,O_SALES,O_FINISH,O_INSPECTION 
FROM LOT_INVENTORY 
WHERE ITEM_CD = '00000087' AND LOCATION_CD = 'G3' AND LOT_NO = '999999'
;
IF O_INVENTORY = LL_INVENTORY AND O_BACKORDER = LL_BACKORDER  AND O_ASSIGN_QTY = LL_ASSIGN_QTY 
   AND O_SALES = LL_SALES AND O_FINISH = LL_FINISH AND O_INSPECTION = LL_INSPECTION THEN
   NULL;
ELSE
	para :='ENTRY_PURCHASE(4,TESTDATA001,som,para); ILLIGAL CREATE LOT_INV'  ;
	GOTO P_END;
END IF;
END IF;
/* INOUT_SOURCE 削除 */
	DBMS_OUTPUT.PUT_LINE('登録取消');
 ZAIKOUKEHARAI.ENTRY_PURCHASE(2,ID,'som',para);
 IF para = 'COMPLETE' THEN NULL;ELSE GOTO P_END;END IF;
SELECT COUNT(*) INTO CT FROM INOUT_SOURCE WHERE ODER_NO = 'TESTDATA001' AND ODER_LINE_NO = 0;
IF CT = 0 THEN 
	NULL;
ELSE
	para :='ENTRY_PURCHASE(4,TESTDATA001,som,para); not DELETE INOUT_SOURCE';
	GOTO P_END;
END IF;



	DBMS_OUTPUT.PUT_LINE('終わった');
	ROLLBACK;
<<P_END>>
	DBMS_OUTPUT.PUT_LINE(para);
END;
/
